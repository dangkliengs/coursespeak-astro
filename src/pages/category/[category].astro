---
import Layout from "../../layouts/Layout.astro";
import { readDeals } from "../../lib/store";
import DealsList from "../../components/DealsList";
import { normName, slugifyCategory } from "../../lib/utils";

export async function getStaticPaths() {
  const deals = await readDeals();
  const cats = new Map();

  for (const d of deals) {
    const cName = normName(d.category) ?? "Uncategorized";
    const cKey = cName.toLowerCase();
    if (!cats.has(cKey)) cats.set(cKey, { name: cName, count: 0 });
    const bucket = cats.get(cKey);
    bucket.count += 1;
  }

  return Array.from(cats.values()).map((c) => {
    const cSlug = slugifyCategory(c.name);
    return {
      params: { category: cSlug },
      props: { 
        categoryName: c.name,
        categorySlug: cSlug
      }
    };
  });
}

const { categoryName, categorySlug } = Astro.props;

const allDeals = await readDeals();
const categoryDeals = allDeals.filter(deal => 
  normName(deal.category) === categoryName || 
  (categoryName === "Uncategorized" && !normName(deal.category))
);

const displayName = categoryName;

// Pagination
const PAGE_SIZE = 12;
const initialItems = categoryDeals.slice(0, PAGE_SIZE);
const totalPages = Math.ceil(categoryDeals.length / PAGE_SIZE);

const pageTitle = `${displayName} Udemy Courses - Best Deals & Discounts | CourseSpeak`;
const pageDescription = `Find ${categoryDeals.length}+ ${displayName.toLowerCase()} Udemy courses with up to 100% off. Latest verified Udemy deals, coupons & discounts. Updated daily.`;
---

<Layout title={pageTitle} description={pageDescription}>
  <div style={{ background: "#0b0d12", minHeight: "100vh", color: "#e2e8f0" }}>
    <div style={{ maxWidth: "1200px", margin: "0 auto", padding: "2rem 1rem" }}>
      <div style={{ marginBottom: "2rem" }}>
        <h1 style={{ 
          fontSize: "2.5rem", 
          fontWeight: 700, 
          color: "#fff", 
          marginBottom: "0.5rem" 
        }}>
          {displayName} Courses
        </h1>
        <p style={{ 
          fontSize: "1.125rem", 
          color: "#a9b0c0", 
          marginBottom: "1rem" 
        }}>
          {categoryDeals.length} courses available
        </p>
        <a href="/deals" style={{ 
          color: "#3b82f6", 
          textDecoration: "none" 
        }}>
          ‚Üê Back to all deals
        </a>
      </div>

      <DealsList
        client:load
        initialItems={initialItems}
        initialPage={1}
        totalPages={totalPages}
        baseParams={{ category: categorySlug }}
        allDeals={categoryDeals}
      />
    </div>
  </div>
</Layout>
