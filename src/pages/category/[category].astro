---
import Layout from "../../layouts/Layout.astro";
import { readDeals } from "../../lib/store";
import DealsList from "../../components/DealsList";

export async function getStaticPaths() {
  const allDeals = await readDeals();
  
  // Get unique categories and slugify them
  const categories = [...new Set(allDeals.map(deal => deal.category).filter(Boolean))];
  
  function slugifyCategory(name: string) {
    if (name === "Uncategorized") return "uncategorized";
    let v = name.toLowerCase();
    v = v.replace(/&amp;/gi, "&");
    v = v.replace(/&/g, " and ");
    v = v.replace(/[^\w\s-]/g, "");
    v = v.trim();
    v = v.replace(/\s+/g, "-");
    v = v.replace(/-+/g, "-");
    return v;
  }
  
  // Create paths for both new slugs and old URLs with %20 for redirects
  const paths = [];
  
  // Add new slug paths
  categories.forEach(category => {
    const slug = slugifyCategory(category);
    paths.push({
      params: { category: slug },
      props: { category: category, isRedirect: false }
    });
  });
  
  // Add old URL paths for redirects
  categories.forEach(category => {
    // URL with %26 (encoded &)
    const oldSlugEncoded = category.toLowerCase().replace(/\s+/g, '%20').replace(/&/g, '%26');
    paths.push({
      params: { category: oldSlugEncoded },
      props: { category: category, isRedirect: true }
    });
    
    // URL with literal & (unencoded)
    const oldSlugLiteral = category.toLowerCase().replace(/\s+/g, '%20').replace(/&/g, '&');
    paths.push({
      params: { category: oldSlugLiteral },
      props: { category: category, isRedirect: true }
    });
    
    // URL with %26amp; (HTML entity)
    const oldSlugHtmlEntity = category.toLowerCase().replace(/\s+/g, '%20').replace(/&/g, '%26amp;');
    paths.push({
      params: { category: oldSlugHtmlEntity },
      props: { category: category, isRedirect: true }
    });
  });
  
  return paths;
}

const { category: categorySlug } = Astro.params; // Get category slug from params
const { category: originalCategory, isRedirect } = Astro.props; // Get props

// Handle redirect for old URLs
if (isRedirect) {
  // Convert to new slug format
  function slugifyCategory(name: string) {
    if (name === "Uncategorized") return "uncategorized";
    let v = name.toLowerCase();
    v = v.replace(/&amp;/gi, "&");
    v = v.replace(/&/g, " and ");
    v = v.replace(/[^\w\s-]/g, "");
    v = v.trim();
    v = v.replace(/\s+/g, "-");
    v = v.replace(/-+/g, "-");
    return v;
  }
  
  const newSlug = slugifyCategory(originalCategory);
  return Astro.redirect(`/category/${newSlug}`, 301);
}

// Get all deals and filter by category
const allDeals = await readDeals();
const url = new URL(Astro.request.url);
const subcategoryParam = url.searchParams.get('subcategory');

let categoryDeals;
let displayName;

if (subcategoryParam) {
  // Filter by specific subcategory
  categoryDeals = allDeals.filter(deal => 
    deal.subcategory === subcategoryParam
  );
  displayName = subcategoryParam.charAt(0).toUpperCase() + subcategoryParam.slice(1);
} else {
  // Filter by category (main category or any subcategory)
  categoryDeals = allDeals.filter(deal => 
    deal.category === originalCategory ||
    deal.subcategory === originalCategory
  );
  displayName = originalCategory.charAt(0).toUpperCase() + originalCategory.slice(1);
}

// Pagination
const PAGE_SIZE = 12;
const initialItems = categoryDeals.slice(0, PAGE_SIZE);
const totalPages = Math.ceil(categoryDeals.length / PAGE_SIZE);

const pageTitle = `${displayName} Courses & Deals - CourseSpeak`;
const pageDescription = `Find the best ${displayName.toLowerCase()} courses and deals. Daily updated discounts on ${displayName.toLowerCase()} courses from top providers like Udemy, Coursera, and more.`;
---

<Layout title={pageTitle} description={pageDescription}>
  <div style={{ background: "#0b0d12", minHeight: "100vh", color: "#e2e8f0" }}>
    <div style={{ maxWidth: "1200px", margin: "0 auto", padding: "2rem 1rem" }}>
      <div style={{ marginBottom: "2rem" }}>
        <h1 style={{ 
          fontSize: "2.5rem", 
          fontWeight: 700, 
          color: "#fff", 
          marginBottom: "0.5rem" 
        }}>
          {displayName} Courses
        </h1>
        <p style={{ 
          fontSize: "1.125rem", 
          color: "#a9b0c0", 
          marginBottom: "1rem" 
        }}>
          {categoryDeals.length} courses available
        </p>
        <a href="/deals" style={{ 
          color: "#3b82f6", 
          textDecoration: "none" 
        }}>
          ‚Üê Back to all deals
        </a>
      </div>

      <DealsList
        client:load
        initialItems={initialItems}
        initialPage={1}
        totalPages={totalPages}
        baseParams={{ category: categorySlug }}
        allDeals={categoryDeals}
      />
    </div>
  </div>
</Layout>
