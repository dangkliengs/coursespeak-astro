---
import Layout from "../../layouts/Layout.astro";
import { readDeals } from "../../lib/store";
import DealsList from "../../components/DealsList";

export async function getStaticPaths() {
  const allDeals = await readDeals();
  
  // Get unique categories and slugify them
  const categories = [...new Set(allDeals.map(deal => deal.category).filter(Boolean))];
  
  function slugifyCategory(name: string) {
    if (name === "Uncategorized") return "uncategorized";
    let v = name.toLowerCase();
    v = v.replace(/&amp;/gi, "&");
    v = v.replace(/&/g, " and ");
    v = v.replace(/[^\w\s-]/g, "");
    v = v.trim();
    v = v.replace(/\s+/g, "-");
    v = v.replace(/-+/g, "-");
    return v;
  }
  
  return categories.map(category => {
    const slug = slugifyCategory(category);
    return {
      params: { category: slug },
      props: { category: category } // Pass original category name for filtering
    };
  });
}

const { category: categorySlug } = Astro.params; // Get category slug from params
const { category: originalCategory } = Astro.props; // Get original category name from props

// Get all deals and filter by category
const allDeals = await readDeals();
const categoryDeals = allDeals.filter(deal => 
  deal.category === originalCategory ||
  deal.subcategory === originalCategory
);

// Pagination
const PAGE_SIZE = 12;
const initialItems = categoryDeals.slice(0, PAGE_SIZE);
const totalPages = Math.ceil(categoryDeals.length / PAGE_SIZE);

// Format category name for display
const displayName = originalCategory.charAt(0).toUpperCase() + originalCategory.slice(1);

const pageTitle = `${displayName} Courses & Deals - CourseSpeak`;
const pageDescription = `Find the best ${displayName.toLowerCase()} courses and deals. Daily updated discounts on ${displayName.toLowerCase()} courses from top providers like Udemy, Coursera, and more.`;
---

<Layout title={pageTitle} description={pageDescription}>
  <div style={{ background: "#0b0d12", minHeight: "100vh", color: "#e2e8f0" }}>
    <div style={{ maxWidth: "1200px", margin: "0 auto", padding: "2rem 1rem" }}>
      <div style={{ marginBottom: "2rem" }}>
        <h1 style={{ 
          fontSize: "2.5rem", 
          fontWeight: 700, 
          color: "#fff", 
          marginBottom: "0.5rem" 
        }}>
          {displayName} Courses
        </h1>
        <p style={{ 
          fontSize: "1.125rem", 
          color: "#a9b0c0", 
          marginBottom: "1rem" 
        }}>
          {categoryDeals.length} courses available
        </p>
        <a href="/deals" style={{ 
          color: "#3b82f6", 
          textDecoration: "none" 
        }}>
          ‚Üê Back to all deals
        </a>
      </div>

      <DealsList
        client:load
        initialItems={initialItems}
        initialPage={1}
        totalPages={totalPages}
        baseParams={{ category: categorySlug }}
        allDeals={categoryDeals}
      />
    </div>
  </div>
</Layout>
