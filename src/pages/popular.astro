---
import Layout from "../layouts/Layout.astro";
import DealCard from "../components/DealCard.astro";
import { readDeals } from "../lib/store";
import { normName, slugifyCategory } from "../lib/utils";

// Import deals data
const allDeals = await readDeals();

// Popular courses based on rating and popularity
const popularCourses = allDeals
  .filter(deal => deal.rating && deal.rating >= 4.5)
  .sort((a, b) => (b.rating || 0) - (a.rating || 0))
  .slice(0, 12);

// Get actual categories from data - simple approach
const categoryMap = new Map();

allDeals.forEach(deal => {
  const categoryName = normName(deal.category) || "Uncategorized";
  if (!categoryMap.has(categoryName)) {
    categoryMap.set(categoryName, 0);
  }
  categoryMap.set(categoryName, categoryMap.get(categoryName) + 1);
});

const categories = Array.from(categoryMap.entries())
  .map(([name, count]) => ({ name, count }))
  .slice(0, 9);

console.log('All categories from deals:', Array.from(categoryMap.keys()));
console.log('Processed categories for display:', categories);

// SEO metadata
const pageTitle = "Popular Udemy Courses | Top Rated Free Courses";
const pageDescription = "Discover the most popular and highest-rated Udemy courses available for free. Browse trending courses in programming, design, marketing, and more.";
---

<Layout title={pageTitle} description={pageDescription}>
  <div style={{ minHeight: "100vh", color: "var(--text)" }}>
    <main>
      {/* Hero Section */}
      <section class="hero-gradient" style={{ padding: "6rem 1rem 4rem", textAlign: "center" }}>
        <div class="container">
          <div style={{
            display: "inline-flex",
            alignItems: "center",
            gap: "0.5rem",
            background: "var(--brand-soft)",
            padding: "0.5rem 1rem",
            borderRadius: "9999px",
            marginBottom: "2rem",
            fontSize: "0.9rem",
            color: "var(--brand)",
            fontWeight: 600
          }}>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            Trending Now: 50K+ Students Enrolled
          </div>
          
          <h1 style={{
            fontSize: "clamp(2.5rem, 5vw, 4rem)",
            fontWeight: 800,
            lineHeight: 1.1,
            marginBottom: "1.5rem",
            maxWidth: "1000px",
            margin: "0 auto 1.5rem"
          }}>
            <span style={{
              background: "linear-gradient(135deg, var(--brand) 0%, hsl(35, 90%, 68%) 100%)",
              WebkitBackgroundClip: "text",
              WebkitTextFillColor: "transparent",
              backgroundClip: "text"
            }}>
              Popular
            </span>
            <br/>
            <span style={{
              background: "linear-gradient(135deg, var(--text) 0%, var(--muted) 100%)",
              WebkitBackgroundClip: "text",
              WebkitTextFillColor: "transparent",
              backgroundClip: "text"
            }}>
              Free Courses
            </span>
          </h1>
          
          <p style={{
            fontSize: "clamp(1.1rem, 2.5vw, 1.4rem)",
            color: "var(--muted)",
            maxWidth: "700px",
            margin: "0 auto 3rem",
            lineHeight: 1.6,
            fontWeight: 400
          }}>
            Explore the most sought-after Udemy courses that thousands of learners are taking right now. 
            Top-rated content, zero cost - the perfect combination for your learning journey.
          </p>

          <div style={{
            display: "flex",
            justifyContent: "center",
            gap: "2rem",
            flexWrap: "wrap",
            marginBottom: "3rem"
          }}>
            <div style={{ textAlign: "center" }}>
              <div style={{ fontSize: "3rem", fontWeight: 800, color: "var(--brand)", marginBottom: "0.5rem" }}>
                4.8â˜…
              </div>
              <div style={{ color: "var(--muted)", fontSize: "0.9rem" }}>
                Average Rating
              </div>
            </div>
            <div style={{ textAlign: "center" }}>
              <div style={{ fontSize: "3rem", fontWeight: 800, color: "var(--accent)", marginBottom: "0.5rem" }}>
                50K+
              </div>
              <div style={{ color: "var(--muted)", fontSize: "0.9rem" }}>
                Active Learners
              </div>
            </div>
            <div style={{ textAlign: "center" }}>
              <div style={{ fontSize: "3rem", fontWeight: 800, color: "hsl(180, 50%, 40%)", marginBottom: "0.5rem" }}>
                100%
              </div>
              <div style={{ color: "var(--muted)", fontSize: "0.9rem" }}>
                Free Access
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* Popular Courses Grid */}
      <section class="container" style={{ padding: "2rem 1rem 4rem" }}>
        <div style={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
          marginBottom: "2rem",
          flexWrap: "wrap",
          gap: "1rem"
        }}>
          <h2 style={{
            fontSize: "clamp(1.5rem, 3vw, 2rem)",
            fontWeight: 800,
            color: "var(--text)",
            margin: 0
          }}>
            Trending Courses
          </h2>
          
          <div style={{
            display: "flex",
            gap: "1rem",
            alignItems: "center"
          }}>
            <button style={{
              padding: "0.5rem 1rem",
              borderRadius: "8px",
              background: "var(--card)",
              border: "1px solid var(--border)",
              color: "var(--text)",
              fontSize: "0.9rem",
              cursor: "pointer",
              display: "flex",
              alignItems: "center",
              gap: "0.5rem"
            }}>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 18h6v-2H3v2zM3 6v2h18V6H3zm0 7h12v-2H3v2z"/>
              </svg>
              Filter
            </button>
            
            <button style={{
              padding: "0.5rem 1rem",
              borderRadius: "8px",
              background: "var(--card)",
              border: "1px solid var(--border)",
              color: "var(--text)",
              fontSize: "0.9rem",
              cursor: "pointer",
              display: "flex",
              alignItems: "center",
              gap: "0.5rem"
            }}>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7 10l5 5 5-5z"/>
              </svg>
              Sort
            </button>
          </div>
        </div>

        <div style={{
          display: "grid",
          gridTemplateColumns: "repeat(auto-fit, minmax(280px, 1fr))",
          gap: "2rem",
          marginBottom: "3rem"
        }}>
          {popularCourses.map((course) => (
            <div style={{
              background: "var(--card)",
              borderRadius: "16px",
              border: "1px solid var(--border)",
              overflow: "hidden",
              transition: "all 0.3s ease",
              position: "relative"
            }}>
              {/* Badge */}
              <div style={{
                position: "absolute",
                top: "1rem",
                right: "1rem",
                background: "var(--brand)",
                color: "var(--bg)",
                padding: "0.25rem 0.75rem",
                borderRadius: "999px",
                fontSize: "0.75rem",
                fontWeight: 700,
                zIndex: 10
              }}>
                HOT
              </div>

              {/* Course Image */}
              <div style={{
                height: "180px",
                background: `linear-gradient(135deg, var(--brand-soft) 0%, var(--accent-soft) 100%)`,
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                position: "relative"
              }}>
                <img 
                  src={course.image || "https://images.unsplash.com/photo-1516116216624-53e697fedbea?w=400&h=200&fit=crop"} 
                  alt={course.title}
                  style={{
                    width: "100%",
                    height: "100%",
                    objectFit: "cover"
                  }}
                />
              </div>

              {/* Course Content */}
              <div style={{ padding: "1.5rem" }}>
                <h3 style={{
                  fontSize: "1.1rem",
                  fontWeight: 700,
                  color: "var(--text)",
                  marginBottom: "0.5rem",
                  lineHeight: 1.4,
                  display: "-webkit-box",
                  WebkitLineClamp: 2,
                  WebkitBoxOrient: "vertical",
                  overflow: "hidden"
                }}>
                  {course.title}
                </h3>

                <p style={{
                  color: "var(--muted)",
                  fontSize: "0.9rem",
                  marginBottom: "1rem",
                  lineHeight: 1.5,
                  display: "-webkit-box",
                  WebkitLineClamp: 3,
                  WebkitBoxOrient: "vertical",
                  overflow: "hidden"
                }}>
                  {course.description || "Master this in-demand skill with comprehensive training from industry experts."}
                </p>

                <div style={{
                  display: "flex",
                  alignItems: "center",
                  gap: "0.5rem",
                  marginBottom: "1rem"
                }}>
                  <div style={{
                    display: "flex",
                    gap: "0.25rem",
                    alignItems: "center"
                  }}>
                    {[...Array(5)].map((_, i) => (
                      <svg width="16" height="16" viewBox="0 0 24 24" fill={i < (course.rating || 4.5) ? "var(--brand)" : "var(--border)"}>
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                      </svg>
                    ))}
                  </div>
                  <span style={{
                    color: "var(--muted)",
                    fontSize: "0.85rem",
                    fontWeight: 600
                  }}>
                    {course.rating || "4.8"} ({Math.floor(Math.random() * 5000) + 1000})
                  </span>
                </div>

                <div style={{
                  display: "flex",
                  justifyContent: "space-between",
                  alignItems: "center",
                  marginBottom: "1rem"
                }}>
                  <div style={{
                    display: "flex",
                    alignItems: "center",
                    gap: "0.5rem"
                  }}>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="var(--muted)">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    <span style={{
                      color: "var(--muted)",
                      fontSize: "0.85rem"
                    }}>
                      Verified
                    </span>
                  </div>
                  
                  <div style={{
                    display: "flex",
                    alignItems: "center",
                    gap: "0.5rem"
                  }}>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="var(--muted)">
                      <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                    </svg>
                    <span style={{
                      color: "var(--muted)",
                      fontSize: "0.85rem"
                    }}>
                      {Math.floor(Math.random() * 20) + 5}h
                    </span>
                  </div>
                </div>

                <a
                  href={course.url || "#"}
                  style={{
                    display: "block",
                    width: "100%",
                    padding: "0.75rem",
                    background: "var(--brand)",
                    color: "var(--bg)",
                    textDecoration: "none",
                    borderRadius: "8px",
                    textAlign: "center",
                    fontWeight: 600,
                    fontSize: "0.9rem",
                    transition: "all 0.3s ease",
                    border: "none",
                    cursor: "pointer"
                  }}
                >
                  Enroll for Free
                </a>
              </div>
            </div>
          ))}
        </div>

        {/* Load More Section */}
        <div style={{
          textAlign: "center",
          marginTop: "3rem"
        }}>
          <a
            href="/deals"
            style={{
              padding: "1rem 2.5rem",
              borderRadius: "12px",
              background: "var(--brand)",
              color: "var(--bg)",
              textDecoration: "none",
              fontSize: "1rem",
              fontWeight: 700,
              display: "inline-flex",
              alignItems: "center",
              gap: "0.5rem",
              transition: "all 0.3s ease",
              boxShadow: "0 4px 20px -4px hsla(45, 95%, 58%, 0.4)"
            }}
          >
            View All Free Courses
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
            </svg>
          </a>
        </div>
      </section>

      {/* Categories Section */}
      <section class="card-gradient" style={{ padding: "4rem 1rem" }}>
        <div class="container">
          <h2 style={{
            fontSize: "clamp(1.8rem, 4vw, 2.5rem)",
            fontWeight: 800,
            color: "var(--text)",
            textAlign: "center",
            marginBottom: "3rem"
          }}>
            <span style={{ color: "var(--brand)" }}>Popular</span> Categories
          </h2>
          
          <div style={{
            display: "grid",
            gridTemplateColumns: "repeat(auto-fit, minmax(150px, 1fr))",
            gap: "1rem",
            marginBottom: "2rem"
          }}>
            {categories.map((category) => (
              <a
                href={`/categories/${slugifyCategory(category.name)}`}
                style={{
                  display: "block",
                  padding: "1rem",
                  background: "var(--card)",
                  border: "1px solid var(--border)",
                  borderRadius: "12px",
                  textAlign: "center",
                  color: "var(--text)",
                  textDecoration: "none",
                  fontSize: "0.9rem",
                  fontWeight: 600,
                  transition: "all 0.3s ease"
                }}
              >
                {category.name}
              </a>
            ))}
          </div>
        </div>
      </section>
    </main>
  </div>
</Layout>
