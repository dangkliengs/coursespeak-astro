---
import Layout from "../../layouts/Layout.astro";
import { readDeals } from "../../lib/store";

const allDeals = await readDeals();

const pageTitle = "Manage Deals - Admin Dashboard";
const pageDescription = "View, edit, and delete course deals on CourseSpeak.";
---

<Layout title={pageTitle} description={pageDescription}>
  <div style={{ background: "#0b0d12", minHeight: "100vh", color: "#e2e8f0" }}>
    <div style={{ maxWidth: "1200px", margin: "0 auto", padding: "2rem 1rem" }}>
      <div style={{ marginBottom: "2rem", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
        <div>
          <h1 style={{ 
            fontSize: "2.5rem", 
            fontWeight: 700, 
            color: "#fff", 
            marginBottom: "0.5rem" 
          }}>
            Manage Deals
          </h1>
          <p style={{ 
            fontSize: "1.125rem", 
            color: "#a9b0c0" 
          }}>
            {allDeals.length} total deals
          </p>
        </div>
        <a href="/admin/deals/create" style={{
          display: "inline-block",
          padding: "0.75rem 1.5rem",
          backgroundColor: "#3b82f6",
          color: "#fff",
          textDecoration: "none",
          borderRadius: "0.5rem",
          fontWeight: 600
        }}>
          + Create New Deal
        </a>
      </div>

      <div style={{
        borderRadius: "1rem",
        border: "1px solid rgba(91, 140, 255, 0.24)",
        background: "linear-gradient(140deg, rgba(11, 13, 18, 0.98) 0%, rgba(18, 24, 40, 0.98) 55%, rgba(42, 64, 110, 0.38) 100%)",
        boxShadow: "0 18px 36px rgba(8, 12, 26, 0.45)",
        overflow: "hidden"
      }}>
        <div style={{ overflowX: "auto" }}>
          <table style={{ width: "100%", borderCollapse: "collapse" }}>
            <thead>
              <tr style={{ borderBottom: "1px solid rgba(91, 140, 255, 0.24)" }}>
                <th style={{ padding: "1rem", textAlign: "left", color: "#fff", fontWeight: 600 }}>Title</th>
                <th style={{ padding: "1rem", textAlign: "left", color: "#fff", fontWeight: 600 }}>Provider</th>
                <th style={{ padding: "1rem", textAlign: "left", color: "#fff", fontWeight: 600 }}>Category</th>
                <th style={{ padding: "1rem", textAlign: "left", color: "#fff", fontWeight: 600 }}>Price</th>
                <th style={{ padding: "1rem", textAlign: "left", color: "#fff", fontWeight: 600 }}>Actions</th>
              </tr>
            </thead>
            <tbody>
              {allDeals.slice(0, 50).map((deal) => (
                <tr key={deal.id} style={{ borderBottom: "1px solid rgba(91, 140, 255, 0.1)" }}>
                  <td style={{ padding: "1rem", color: "#e2e8f0" }}>
                    <div style={{ maxWidth: "300px" }}>
                      <div style={{ fontWeight: 600, marginBottom: "0.25rem" }}>{deal.title}</div>
                      <div style={{ fontSize: "0.875rem", color: "#a9b0c0" }}>ID: {deal.id}</div>
                    </div>
                  </td>
                  <td style={{ padding: "1rem", color: "#e2e8f0" }}>{deal.provider}</td>
                  <td style={{ padding: "1rem", color: "#e2e8f0" }}>
                    <div>
                      <div>{deal.category}</div>
                      {deal.subcategory && (
                        <div style={{ fontSize: "0.875rem", color: "#a9b0c0" }}>{deal.subcategory}</div>
                      )}
                    </div>
                  </td>
                  <td style={{ padding: "1rem", color: "#e2e8f0" }}>
                    ${deal.price}
                    {deal.originalPrice && (
                      <span style={{ 
                        textDecoration: "line-through", 
                        color: "#a9b0c0", 
                        marginLeft: "0.5rem" 
                      }}>
                        ${deal.originalPrice}
                      </span>
                    )}
                  </td>
                  <td style={{ padding: "1rem" }}>
                    <div style={{ display: "flex", gap: "0.5rem" }}>
                      <a href={`/admin/deals/edit/${deal.id}`} style={{
                        padding: "0.5rem 1rem",
                        backgroundColor: "transparent",
                        color: "#3b82f6",
                        border: "1px solid #3b82f6",
                        textDecoration: "none",
                        borderRadius: "0.375rem",
                        fontSize: "0.875rem",
                        fontWeight: 600
                      }}>
                        Edit
                      </a>
                      <button 
                        onclick={`deleteDeal('${deal.id}')`}
                        style={{
                          padding: "0.5rem 1rem",
                          backgroundColor: "transparent",
                          color: "#ef4444",
                          border: "1px solid #ef4444",
                          borderRadius: "0.375rem",
                          fontSize: "0.875rem",
                          fontWeight: 600,
                          cursor: "pointer"
                        }}
                      >
                        Delete
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        
        {allDeals.length > 50 && (
          <div style={{ padding: "1rem", textAlign: "center", color: "#a9b0c0" }}>
            Showing first 50 deals of {allDeals.length}
          </div>
        )}
      </div>
    </div>
  </div>

  <script>
    async function deleteDeal(id) {
      if (!confirm('Are you sure you want to delete this deal?')) return;
      
      try {
        const response = await fetch(`/api/deals/${id}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          alert('Deal deleted successfully');
          window.location.reload();
        } else {
          alert('Failed to delete deal');
        }
      } catch (error) {
        alert('Error deleting deal: ' + error.message);
      }
    }
  </script>
</Layout>
