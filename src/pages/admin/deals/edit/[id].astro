---
import Layout from "../../../../layouts/Layout.astro";
import AdminProtection from "../../../../components/AdminProtection.astro";
import AdminAuthGate from "../../../../components/AdminAuthGate";
import { readDeals } from "../../../../lib/store";

export async function getStaticPaths() {
  const allDeals = await readDeals();
  
  return allDeals.map(deal => ({
    params: { id: deal.id },
    props: { deal }
  }));
}

// Get deal from props instead of params
const { deal } = Astro.props;

const pageTitle = `Edit Deal: ${deal.title} - Admin Dashboard`;
const pageDescription = `Edit course deal: ${deal.title} on CourseSpeak.`;
---

<Layout title={pageTitle} description={pageDescription}>
  <AdminProtection>
    <AdminAuthGate>
  <div style={{ background: "#0b0d12", minHeight: "100vh", color: "#e2e8f0" }}>
    <div style={{ maxWidth: "800px", margin: "0 auto", padding: "2rem 1rem" }}>
      <div style={{ marginBottom: "2rem" }}>
        <h1 style={{ 
          fontSize: "2.5rem", 
          fontWeight: 700, 
          color: "#fff", 
          marginBottom: "0.5rem" 
        }}>
          Edit Deal
        </h1>
        <p style={{ 
          fontSize: "1.125rem", 
          color: "#a9b0c0" 
        }}>
          Edit course: {deal.title}
        </p>
      </div>

      <form 
        action="#" 
        method="POST"
        id="editForm"
        style={{
          borderRadius: "1rem",
          border: "1px solid rgba(91, 140, 255, 0.24)",
          background: "linear-gradient(140deg, rgba(11, 13, 18, 0.98) 0%, rgba(18, 24, 40, 0.98) 55%, rgba(42, 64, 110, 0.38) 100%)",
          boxShadow: "0 18px 36px rgba(8, 12, 26, 0.45)",
          padding: "2rem"
        }}
      >
        <input type="hidden" name="id" value={deal.id} />
        
        <div style={{ display: "grid", gap: "1.5rem" }}>
          <div>
            <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
              Course Title *
            </label>
            <input 
              type="text" 
              name="title" 
              required
              value={deal.title}
              style={{
                width: "100%",
                padding: "0.75rem",
                backgroundColor: "rgba(31, 35, 48, 0.8)",
                border: "1px solid rgba(91, 140, 255, 0.24)",
                borderRadius: "0.5rem",
                color: "#e2e8f0",
                fontSize: "1rem"
              }}
            />
          </div>

          <div style={{ display: "grid", gridTemplateColumns: "1fr, 1fr 1fr", gap: "1rem" }}>
            <div>
              <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
                Provider *
              </label>
              <select 
                name="provider" 
                required
                style={{
                  width: "100%",
                  padding: "0.75rem",
                  backgroundColor: "rgba(31, 35, 48, 0.8)",
                  border: "1px solid rgba(91, 140, 255, 0.24)",
                  borderRadius: "0.5rem",
                  color: "#e2e8f0",
                  fontSize: "1rem"
                }}
              >
                <option value="Udemy" selected={deal.provider === "Udemy"}>Udemy</option>
                <option value="Coursera" selected={deal.provider === "Coursera"}>Coursera</option>
                <option value="edX" selected={deal.provider === "edX"}>edX</option>
                <option value="Skillshare" selected={deal.provider === "Skillshare"}>Skillshare</option>
                <option value="Pluralsight" selected={deal.provider === "Pluralsight"}>Pluralsight</option>
              </select>
            </div>

            <div>
              <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
                Course URL *
              </label>
              <input 
                type="url" 
                name="url" 
                required
                value={deal.url}
                style={{
                  width: "100%",
                  padding: "0.75rem",
                  backgroundColor: "rgba(31, 35, 48, 0.8)",
                  border: "1px solid rgba(91, 140, 255, 0.24)",
                  borderRadius: "0.5rem",
                  color: "#e2e8f0",
                  fontSize: "1rem"
                }}
              />
            </div>
          </div>

          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "1rem" }}>
            <div>
              <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
                Category *
              </label>
              <input 
                type="text" 
                name="category" 
                required
                value={deal.category}
                style={{
                  width: "100%",
                  padding: "0.75rem",
                  backgroundColor: "rgba(31, 35, 48, 0.8)",
                  border: "1px solid rgba(91, 140, 255, 0.24)",
                  borderRadius: "0.5rem",
                  color: "#e2e8f0",
                  fontSize: "1rem"
                }}
              />
            </div>

            <div>
              <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
                Subcategory
              </label>
              <input 
                type="text" 
                name="subcategory"
                value={deal.subcategory || ""}
                style={{
                  width: "100%",
                  padding: "0.75rem",
                  backgroundColor: "rgba(31, 35, 48, 0.8)",
                  border: "1px solid rgba(91, 140, 255, 0.24)",
                  borderRadius: "0.5rem",
                  color: "#e2e8f0",
                  fontSize: "1rem"
                }}
              />
            </div>
          </div>

          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: "1rem" }}>
            <div>
              <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
                Price ($) *
              </label>
              <input 
                type="number" 
                name="price" 
                step="0.01"
                min="0"
                required
                value={deal.price}
                style={{
                  width: "100%",
                  padding: "0.75rem",
                  backgroundColor: "rgba(31, 35, 48, 0.8)",
                  border: "1px solid rgba(91, 140, 255, 0.24)",
                  borderRadius: "0.5rem",
                  color: "#e2e8f0",
                  fontSize: "1rem"
                }}
              />
            </div>

            <div>
              <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
                Original Price ($)
              </label>
              <input 
                type="number" 
                name="originalPrice" 
                step="0.01"
                min="0"
                value={deal.originalPrice || ""}
                style={{
                  width: "100%",
                  padding: "0.75rem",
                  backgroundColor: "rgba(31, 35, 48, 0.8)",
                  border: "1px solid rgba(91, 140, 255, 0.24)",
                  borderRadius: "0.5rem",
                  color: "#e2e8f0",
                  fontSize: "1rem"
                }}
              />
            </div>

            <div>
              <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
                Rating
              </label>
              <input 
                type="number" 
                name="rating" 
                step="0.1"
                min="0"
                max="5"
                value={deal.rating || ""}
                style={{
                  width: "100%",
                  padding: "0.75rem",
                  backgroundColor: "rgba(31, 35, 48, 0.8)",
                  border: "1px solid rgba(91, 140, 255, 0.24)",
                  borderRadius: "0.5rem",
                  color: "#e2e8f0",
                  fontSize: "1rem"
                }}
              />
            </div>
          </div>

          <div>
            <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
              Description
            </label>
            <textarea 
              name="description" 
              rows="3"
              style={{
                width: "100%",
                padding: "0.75rem",
                backgroundColor: "rgba(31, 35, 48, 0.8)",
                border: "1px solid rgba(91, 140, 255, 0.24)",
                borderRadius: "0.5rem",
                color: "#e2e8f0",
                fontSize: "1rem",
                resize: "vertical"
              }}
            >{deal.description || ""}</textarea>
          </div>

          <div>
            <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
              Content (Full Course Content)
            </label>
            
            <!-- Rich Text Editor Toolbar -->
            <div style={{
              marginBottom: "0.5rem",
              display: "flex",
              gap: "0.5rem",
              flexWrap: "wrap",
              padding: "0.5rem",
              backgroundColor: "rgba(31, 35, 48, 0.8)",
              border: "1px solid rgba(91, 140, 255, 0.24)",
              borderRadius: "0.5rem 0.5rem 0 0"
            }}>
              <button type="button" onclick="formatText('bold')" style={{
                padding: "0.5rem 0.75rem",
                backgroundColor: "#3b82f6",
                color: "#fff",
                border: "none",
                borderRadius: "0.25rem",
                cursor: "pointer",
                fontWeight: "bold",
                fontSize: "0.875rem"
              }}>B</button>
              
              <button type="button" onclick="formatText('italic')" style={{
                padding: "0.5rem 0.75rem",
                backgroundColor: "#3b82f6",
                color: "#fff",
                border: "none",
                borderRadius: "0.25rem",
                cursor: "pointer",
                fontStyle: "italic",
                fontSize: "0.875rem"
              }}>I</button>
              
              <button type="button" onclick="formatText('underline')" style={{
                padding: "0.5rem 0.75rem",
                backgroundColor: "#3b82f6",
                color: "#fff",
                border: "none",
                borderRadius: "0.25rem",
                cursor: "pointer",
                textDecoration: "underline",
                fontSize: "0.875rem"
              }}>U</button>
              
              <div style={{ width: "1px", height: "24px", backgroundColor: "rgba(91, 140, 255, 0.24)" }}></div>
              
              <button type="button" onclick="formatText('insertUnorderedList')" style={{
                padding: "0.5rem 0.75rem",
                backgroundColor: "#3b82f6",
                color: "#fff",
                border: "none",
                borderRadius: "0.25rem",
                cursor: "pointer",
                fontSize: "0.875rem"
              }}>â€¢ List</button>
              
              <button type="button" onclick="formatText('insertOrderedList')" style={{
                padding: "0.5rem 0.75rem",
                backgroundColor: "#3b82f6",
                color: "#fff",
                border: "none",
                borderRadius: "0.25rem",
                cursor: "pointer",
                fontSize: "0.875rem"
              }}>1. List</button>
              
              <div style={{ width: "1px", height: "24px", backgroundColor: "rgba(91, 140, 255, 0.24)" }}></div>
              
              <button type="button" onclick="insertLink()" style={{
                padding: "0.5rem 0.75rem",
                backgroundColor: "#10b981",
                color: "#fff",
                border: "none",
                borderRadius: "0.25rem",
                cursor: "pointer",
                fontSize: "0.875rem"
              }}>Link</button>
              
              <button type="button" onclick="formatText('removeFormat')" style={{
                padding: "0.5rem 0.75rem",
                backgroundColor: "#ef4444",
                color: "#fff",
                border: "none",
                borderRadius: "0.25rem",
                cursor: "pointer",
                fontSize: "0.875rem"
              }}>Clear</button>
            </div>
            
            <!-- Rich Text Editor Content Area -->
            <div 
              id="contentEditor"
              contenteditable="true"
              style={{
                width: "100%",
                minHeight: "200px",
                padding: "0.75rem",
                backgroundColor: "rgba(31, 35, 48, 0.8)",
                border: "1px solid rgba(91, 140, 255, 0.24)",
                borderRadius: "0 0 0.5rem 0.5rem",
                color: "#e2e8f0",
                fontSize: "1rem",
                lineHeight: "1.5",
                overflowY: "auto",
                maxHeight: "400px"
              }}
            >{deal.content || ""}</div>
            
            <!-- Hidden textarea to store content for form submission -->
            <textarea 
              name="content" 
              id="contentTextarea"
              style={{ display: "none" }}
            >{deal.content || ""}</textarea>
          </div>

          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "1rem" }}>
            <div>
              <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
                Instructor
              </label>
              <input 
                type="text" 
                name="instructor"
                value={deal.instructor || ""}
                style={{
                  width: "100%",
                  padding: "0.75rem",
                  backgroundColor: "rgba(31, 35, 48, 0.8)",
                  border: "1px solid rgba(91, 140, 255, 0.24)",
                  borderRadius: "0.5rem",
                  color: "#e2e8f0",
                  fontSize: "1rem"
                }}
              />
            </div>

            <div>
              <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
                Duration
              </label>
              <input 
                type="text" 
                name="duration"
                value={deal.duration || ""}
                style={{
                  width: "100%",
                  padding: "0.75rem",
                  backgroundColor: "rgba(31, 35, 48, 0.8)",
                  border: "1px solid rgba(91, 140, 255, 0.24)",
                  borderRadius: "0.5rem",
                  color: "#e2e8f0",
                  fontSize: "1rem"
                }}
                placeholder="e.g., 5h 30m"
              />
            </div>
          </div>

          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: "1rem" }}>
            <div>
              <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
                Language
              </label>
              <input 
                type="text" 
                name="language"
                value={deal.language || ""}
                style={{
                  width: "100%",
                  padding: "0.75rem",
                  backgroundColor: "rgba(31, 35, 48, 0.8)",
                  border: "1px solid rgba(91, 140, 255, 0.24)",
                  borderRadius: "0.5rem",
                  color: "#e2e8f0",
                  fontSize: "1rem"
                }}
                placeholder="English"
              />
            </div>

            <div>
              <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
                Coupon Code
              </label>
              <input 
                type="text" 
                name="coupon"
                value={deal.coupon || ""}
                style={{
                  width: "100%",
                  padding: "0.75rem",
                  backgroundColor: "rgba(31, 35, 48, 0.8)",
                  border: "1px solid rgba(91, 140, 255, 0.24)",
                  borderRadius: "0.5rem",
                  color: "#e2e8f0",
                  fontSize: "1rem"
                }}
              />
            </div>

            <div>
              <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
                Expires At
              </label>
              <input 
                type="datetime-local" 
                name="expiresAt"
                value={deal.expiresAt ? new Date(deal.expiresAt).toISOString().slice(0, 16) : ""}
                style={{
                  width: "100%",
                  padding: "0.75rem",
                  backgroundColor: "rgba(31, 35, 48, 0.8)",
                  border: "1px solid rgba(91, 140, 255, 0.24)",
                  borderRadius: "0.5rem",
                  color: "#e2e8f0",
                  fontSize: "1rem"
                }}
              />
            </div>
          </div>

          <div>
            <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
              What You'll Learn (one per line)
            </label>
            <textarea 
              name="learn"
              rows="4"
              style={{
                width: "100%",
                padding: "0.75rem",
                backgroundColor: "rgba(31, 35, 48, 0.8)",
                border: "1px solid rgba(91, 140, 255, 0.24)",
                borderRadius: "0.5rem",
                color: "#e2e8f0",
                fontSize: "1rem",
                resize: "vertical"
              }}
              placeholder="Strategy for increasing data quality&#10;Ways to assess data quality&#10;How to spot problems in data"
            >{(deal.learn || []).join('\n')}</textarea>
          </div>

          <div>
            <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
              Requirements (one per line)
            </label>
            <textarea 
              name="requirements"
              rows="3"
              style={{
                width: "100%",
                padding: "0.75rem",
                backgroundColor: "rgba(31, 35, 48, 0.8)",
                border: "1px solid rgba(91, 140, 255, 0.24)",
                borderRadius: "0.5rem",
                color: "#e2e8f0",
                fontSize: "1rem",
                resize: "vertical"
              }}
              placeholder="Interest in working with data&#10;Some Python skills are useful"
            >{(deal.requirements || []).join('\n')}</textarea>
          </div>

          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "1rem" }}>
            <div>
              <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
                SEO Title
              </label>
              <input 
                type="text" 
                name="seoTitle"
                value={deal.seoTitle || ""}
                style={{
                  width: "100%",
                  padding: "0.75rem",
                  backgroundColor: "rgba(31, 35, 48, 0.8)",
                  border: "1px solid rgba(91, 140, 255, 0.24)",
                  borderRadius: "0.5rem",
                  color: "#e2e8f0",
                  fontSize: "1rem"
                }}
              />
            </div>

            <div>
              <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
                SEO Description
              </label>
              <input 
                type="text" 
                name="seoDescription"
                value={deal.seoDescription || ""}
                style={{
                  width: "100%",
                  padding: "0.75rem",
                  backgroundColor: "rgba(31, 35, 48, 0.8)",
                  border: "1px solid rgba(91, 140, 255, 0.24)",
                  borderRadius: "0.5rem",
                  color: "#e2e8f0",
                  fontSize: "1rem"
                }}
              />
            </div>
          </div>

          <div>
            <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
              SEO OG Image URL
            </label>
            <input 
              type="url" 
              name="seoOgImage"
              value={deal.seoOgImage || ""}
              style={{
                width: "100%",
                padding: "0.75rem",
                backgroundColor: "rgba(31, 35, 48, 0.8)",
                border: "1px solid rgba(91, 140, 255, 0.24)",
                borderRadius: "0.5rem",
                color: "#e2e8f0",
                fontSize: "1rem"
              }}
            />
          </div>

          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "1rem" }}>
            <div>
              <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
                Students
              </label>
              <input 
                type="number" 
                name="students" 
                min="0"
                value={deal.students || ""}
                style={{
                  width: "100%",
                  padding: "0.75rem",
                  backgroundColor: "rgba(31, 35, 48, 0.8)",
                  border: "1px solid rgba(91, 140, 255, 0.24)",
                  borderRadius: "0.5rem",
                  color: "#e2e8f0",
                  fontSize: "1rem"
                }}
              />
            </div>

            <div>
              <label style={{ display: "block", color: "#fff", fontWeight: 600, marginBottom: "0.5rem" }}>
                Image URL
              </label>
              <input 
                type="url" 
                name="image"
                value={deal.image || ""}
                style={{
                  width: "100%",
                  padding: "0.75rem",
                  backgroundColor: "rgba(31, 35, 48, 0.8)",
                  border: "1px solid rgba(91, 140, 255, 0.24)",
                  borderRadius: "0.5rem",
                  color: "#e2e8f0",
                  fontSize: "1rem"
                }}
              />
            </div>
          </div>
        </div>

        <div style={{ display: "flex", gap: "1rem", marginTop: "2rem" }}>
          <button 
            type="submit"
            style={{
              padding: "0.75rem 2rem",
              backgroundColor: "#3b82f6",
              color: "#fff",
              border: "none",
              borderRadius: "0.5rem",
              fontSize: "1rem",
              fontWeight: 600,
              cursor: "pointer"
            }}
          >
            Update Deal
          </button>
          <a 
            href="/admin/deals"
            style={{
              padding: "0.75rem 2rem",
              backgroundColor: "transparent",
              color: "#9ca3af",
              border: "1px solid #4b5563",
              textDecoration: "none",
              borderRadius: "0.5rem",
              fontSize: "1rem",
              fontWeight: 600,
              display: "inline-block"
            }}
          >
            Cancel
          </a>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Rich Text Editor Functions
    function formatText(command: string) {
      document.execCommand(command, false, undefined);
      const contentEditor = document.getElementById('contentEditor') as HTMLTextAreaElement;
      if (contentEditor) contentEditor.focus();
    }
    
    function insertLink() {
      const url = prompt('Enter URL:');
      if (url) {
        document.execCommand('createLink', false, url);
        const contentEditor = document.getElementById('contentEditor') as HTMLTextAreaElement;
        if (contentEditor) contentEditor.focus();
      }
    }
    
    // Clean HTML on paste
    function cleanHTML(html: string) {
      // Remove only problematic inline styles and attributes, keep formatting
      let clean = html
        // Remove problematic styles but keep basic formatting
        .replace(/style="[^"]*(?:color|font-family|font-size|margin|padding|max-inline-size)[^"]*"/gi, '')
        .replace(/class="[^"]*"/gi, '')
        .replace(/data-[^=]*="[^"]*"/gi, '')
        // Keep semantic HTML tags but clean them
        .replace(/<p[^>]*>/gi, '<p>')
        .replace(/<\/p>/gi, '</p>')
        .replace(/<span[^>]*>/gi, '<span>')
        .replace(/<\/span>/gi, '</span>')
        .replace(/<div[^>]*>/gi, '<div>')
        .replace(/<\/div>/gi, '</div>')
        // Keep formatting tags
        .replace(/<strong[^>]*>/gi, '<strong>')
        .replace(/<\/strong>/gi, '</strong>')
        .replace(/<b[^>]*>/gi, '<b>')
        .replace(/<\/b>/gi, '</b>')
        .replace(/<em[^>]*>/gi, '<em>')
        .replace(/<\/em>/gi, '</em>')
        .replace(/<i[^>]*>/gi, '<i>')
        .replace(/<\/i>/gi, '</i>')
        // Keep list tags
        .replace(/<ul[^>]*>/gi, '<ul>')
        .replace(/<\/ul>/gi, '</ul>')
        .replace(/<ol[^>]*>/gi, '<ol>')
        .replace(/<\/ol>/gi, '</ol>')
        .replace(/<li[^>]*>/gi, '<li>')
        .replace(/<\/li>/gi, '</li>')
        // Clean up HTML entities
        .replace(/&quot;/g, '"')
        .replace(/&amp;/g, '&')
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>')
        // Remove specific problematic style attributes
        .replace(/margin:\s*[^;]*;?/gi, '')
        .replace(/padding:\s*[^;]*;?/gi, '')
        .replace(/font-size:\s*[^;]*;?/gi, '')
        .replace(/font-family:\s*[^;]*;?/gi, '')
        .replace(/color:\s*[^;]*;?/gi, '')
        .replace(/max-inline-size:\s*[^;]*;?/gi, '');
      
      return clean;
    }
    
    // Handle paste events
    function handlePaste(e: ClipboardEvent) {
      e.preventDefault();
      const clipboardData = e.clipboardData || (window as any).clipboardData;
      let html = clipboardData?.getData('text/html');
      let text = clipboardData.getData('text/plain');
      
      if (html) {
        // Clean the HTML and paste it
        const cleanHtml = cleanHTML(html);
        document.execCommand('insertHTML', false, cleanHtml);
      } else if (text) {
        // Paste as plain text
        document.execCommand('insertText', false, text);
      }
    }
    
    // Sync rich text editor content to hidden textarea
    function syncContent() {
      const editor = document.getElementById('contentEditor') as HTMLElement;
      const textarea = document.getElementById('contentTextarea') as HTMLTextAreaElement;
      if (editor && textarea) {
        textarea.value = editor.innerHTML;
      }
    }
    
    // Initialize rich text editor
    document.addEventListener('DOMContentLoaded', function() {
      const editor = document.getElementById('contentEditor');
      if (editor) {
        // Sync content on input
        editor.addEventListener('input', syncContent);
        
        // Handle paste events
        editor.addEventListener('paste', handlePaste);
        
        // Sync content on paste (fallback)
        editor.addEventListener('paste', function() {
          setTimeout(syncContent, 10);
        });
        
        // Initial sync
        syncContent();
      }
    });
    
    // Make functions globally available
    // Add type declarations for global window
    declare global {
      interface Window {
        formatText: (command: string) => void;
        insertLink: () => void;
        cleanHTML: (html: string) => string;
      }
    }
    
    window.formatText = formatText;
    window.insertLink = insertLink;
    window.cleanHTML = cleanHTML;
    
    document.getElementById('editForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Sync rich text editor content before submission
      syncContent();
      
      const form = e.target as HTMLFormElement;
      const formData = new FormData(form);
      const dealData: any = {};
      
      // Convert FormData to object with proper type checking
      for (const [key, value] of formData.entries()) {
        if (typeof value === 'string') {
          dealData[key] = value;
        }
      }
      
      // Convert numeric fields with type checking
      if (dealData.price && typeof dealData.price === 'string') {
        dealData.price = parseFloat(dealData.price);
      }
      if (dealData.originalPrice && typeof dealData.originalPrice === 'string') {
        dealData.originalPrice = parseFloat(dealData.originalPrice);
      }
      if (dealData.rating && typeof dealData.rating === 'string') {
        dealData.rating = parseFloat(dealData.rating);
      }
      if (dealData.students && typeof dealData.students === 'string') {
        dealData.students = parseInt(dealData.students);
      }
      
      // Convert array fields from textarea (one per line)
      if (dealData.learn && typeof dealData.learn === 'string') {
        dealData.learn = dealData.learn.split('\n').filter((item: string) => item.trim());
      }
      if (dealData.requirements && typeof dealData.requirements === 'string') {
        dealData.requirements = dealData.requirements.split('\n').filter((item: string) => item.trim());
      }
      
      // Convert datetime to ISO string
      if (dealData.expiresAt && typeof dealData.expiresAt === 'string') {
        dealData.expiresAt = new Date(dealData.expiresAt).toISOString();
      }
      
      // Set updated timestamp
      dealData.updatedAt = new Date().toISOString();
      
      console.log('Updated deal data:', dealData);
      
      try {
        console.log('Updating deal:', dealData);
        
        // Try direct file update for local development
        const response = await fetch('/api/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dealData)
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            console.log('Deal updated successfully:', result.updatedDeal);
            alert('Deal updated successfully!');
            window.location.href = '/admin/deals';
          } else {
            throw new Error(result.error || 'Update failed');
          }
        } else {
          throw new Error('API not available');
        }
        
      } catch (error) {
        console.error('Update error:', error);
        
        // Fallback to client-side for GitHub Pages or API failure
        localStorage.setItem('pendingDealUpdate', JSON.stringify(dealData));
        
        alert('Update completed! Data saved to localStorage.\n\nFor local development: Check browser console\nFor GitHub Pages: Copy data and update deals.json manually');
        
        console.log('Updated deal data:', dealData);
        console.log('To apply this update manually, replace the deal with this ID in deals.json:', dealData.id);
        
        // Copy to clipboard
        if (navigator.clipboard) {
          await navigator.clipboard.writeText(JSON.stringify(dealData, null, 2));
          alert('Deal data copied to clipboard!');
        }
      }
    });
  </script>
  </AdminAuthGate>
  </AdminProtection>
</Layout>
