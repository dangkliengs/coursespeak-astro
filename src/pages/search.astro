---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Search - CourseSpeak">
  <div style={{ padding: '32px 16px' }}>
    <h1 id="search-title" style={{ color: '#fff', fontSize: '2rem', marginBottom: '16px' }}>Search</h1>
    <p id="search-description" style={{ color: '#9ca3af', fontSize: '1rem', marginBottom: '32px', display: 'none' }}></p>
    
    <div id="search-results" style={{
      display: 'grid',
      gridTemplateColumns: "repeat(auto-fill, minmax(280px, 1fr))",
      gap: '24px'
    }}></div>
    
    <div id="search-navigation" style={{ 
      display: 'none', 
      justifyContent: 'center', 
      alignItems: 'center', 
      gap: '16px', 
      marginTop: '48px',
      padding: '20px'
    }}>
      <button id="prev-page" style={{
        background: '#3b82f6',
        color: 'white',
        border: 'none',
        padding: '10px 20px',
        borderRadius: '6px',
        cursor: 'pointer',
        fontSize: '14px',
        fontWeight: '500'
      }}>
        ← Previous
      </button>
      <span id="page-info" style={{ color: '#9ca3af', fontSize: '14px' }}></span>
      <button id="next-page" style={{
        background: '#3b82f6',
        color: 'white',
        border: 'none',
        padding: '10px 20px',
        borderRadius: '6px',
        cursor: 'pointer',
        fontSize: '14px',
        fontWeight: '500'
      }}>
        Next →
      </button>
    </div>
    
    <div id="no-results" style={{ display: 'none', textAlign: 'center', padding: '64px 16px' }}>
      <h2 style={{ color: '#fff', fontSize: '1.5rem', marginBottom: '16px' }}>No results found</h2>
      <p style={{ color: '#9ca3af', marginBottom: '24px' }}>Try searching for something else</p>
      <a href="/deals" style={{ color: '#3b82f6', textDecoration: 'none', fontWeight: '500' }}>
        Browse all deals →
      </a>
    </div>
  </div>

  <script>
    let currentPage = 1;
    const itemsPerPage = 12;
    let allDeals: any[] = [];
    
    async function performSearch() {
      const urlParams = new URLSearchParams(window.location.search);
      const query = urlParams.get('q');
      
      const resultsContainer = document.getElementById('search-results');
      const noResults = document.getElementById('no-results');
      const navigation = document.getElementById('search-navigation');
      const searchTitle = document.getElementById('search-title');
      const searchDescription = document.getElementById('search-description');
      
      if (!query) {
        if (resultsContainer) resultsContainer.innerHTML = '<p style="color: #9ca3af;">Please enter a search term</p>';
        if (noResults) noResults.style.display = 'none';
        if (navigation) navigation.style.display = 'none';
        if (searchDescription) searchDescription.style.display = 'none';
        return;
      }
      
      // Update SEO-friendly title
      if (searchTitle) {
        searchTitle.textContent = `Search Results for "${query}"`;
      }
      
      // Update page title for SEO
      document.title = `Search Results for "${query}" - CourseSpeak`;
      
      try {
        const response = await fetch('/api/deals');
        const deals = await response.json();
        
        allDeals = deals.filter((deal: any) => 
          deal.title.toLowerCase().includes(query.toLowerCase()) ||
          (deal.description && deal.description.toLowerCase().includes(query.toLowerCase())) ||
          (deal.category && deal.category.toLowerCase().includes(query.toLowerCase()))
        );
        
        currentPage = 1;
        
        // Update SEO-friendly description with results count
        if (searchDescription) {
          searchDescription.style.display = 'block';
          searchDescription.textContent = `Found ${allDeals.length} deals matching "${query}". Browse the best courses and deals for ${query}.`;
        }
        
        displayResults();
        updateNavigation();
        
      } catch (error) {
        console.error('Search error:', error);
        if (resultsContainer) resultsContainer.innerHTML = '<p style="color: #ef4444;">Error loading search results</p>';
        if (noResults) noResults.style.display = 'none';
        if (navigation) navigation.style.display = 'none';
      }
    }
    
    function displayResults() {
      const resultsContainer = document.getElementById('search-results');
      const noResults = document.getElementById('no-results');
      const navigation = document.getElementById('search-navigation');
      
      if (allDeals.length === 0) {
        if (resultsContainer) resultsContainer.innerHTML = '';
        if (noResults) noResults.style.display = 'block';
        if (navigation) navigation.style.display = 'none';
        return;
      }
      
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageDeals = allDeals.slice(startIndex, endIndex);
      
      if (resultsContainer) {
        resultsContainer.innerHTML = pageDeals.map((deal: any) => {
          const price = deal.price || 'Free';
          const imageUrl = deal.image || '';
          const category = deal.category || '';
          const subcategory = deal.subcategory || '';
          
          let cardHTML = '<article style="border: 1px solid #2d3748; border-radius: 12px; overflow: hidden; background: #1a1a1a; transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;">';
          
          if (imageUrl) {
            cardHTML += '<div style="position: relative; height: 160px; overflow: hidden;">';
            cardHTML += '<img src="' + imageUrl + '" alt="' + deal.title + '" style="width: 100%; height: 160px; object-fit: cover;">';
            cardHTML += '</div>';
          }
          
          cardHTML += '<div style="padding: 20px;">';
          cardHTML += '<h3 style="color: #fff; font-size: 1.1rem; margin-bottom: 12px; line-height: 1.4;">' + deal.title + '</h3>';
          
          if (category || subcategory) {
            cardHTML += '<div style="display: flex; gap: 8px; margin-bottom: 12px;">';
            if (category) cardHTML += '<span style="background: #3b82f6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">' + category + '</span>';
            if (subcategory) cardHTML += '<span style="background: #6b7280; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">' + subcategory + '</span>';
            cardHTML += '</div>';
          }
          
          cardHTML += '<div style="display: flex; justify-content: space-between; align-items: center;">';
          cardHTML += '<span style="color: #3b82f6; font-size: 1.25rem; font-weight: bold;">' + (price === 'Free' ? 'Free' : '$' + price) + '</span>';
          cardHTML += '<a href="/deal/' + deal.id + '" style="background: #10b981; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 0.9rem; font-weight: 500;">View Deal</a>';
          cardHTML += '</div>';
          
          cardHTML += '</div>';
          cardHTML += '</article>';
          
          return cardHTML;
        }).join('');
      }
      
      if (noResults) noResults.style.display = 'none';
      if (navigation) navigation.style.display = allDeals.length > itemsPerPage ? 'flex' : 'none';
    }
    
    function updateNavigation() {
      const prevButton = document.getElementById('prev-page');
      const nextButton = document.getElementById('next-page');
      const pageInfo = document.getElementById('page-info');
      
      const totalPages = Math.ceil(allDeals.length / itemsPerPage);
      
      if (prevButton) {
        (prevButton as HTMLButtonElement).disabled = currentPage === 1;
        prevButton.style.opacity = currentPage === 1 ? '0.5' : '1';
        prevButton.style.cursor = currentPage === 1 ? 'not-allowed' : 'pointer';
      }
      
      if (nextButton) {
        (nextButton as HTMLButtonElement).disabled = currentPage === totalPages;
        nextButton.style.opacity = currentPage === totalPages ? '0.5' : '1';
        nextButton.style.cursor = currentPage === totalPages ? 'not-allowed' : 'pointer';
      }
      
      if (pageInfo) {
        pageInfo.textContent = 'Page ' + currentPage + ' of ' + totalPages;
      }
    }
    
    function goToPage(page: number) {
      const totalPages = Math.ceil(allDeals.length / itemsPerPage);
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        displayResults();
        updateNavigation();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      const prevButton = document.getElementById('prev-page');
      const nextButton = document.getElementById('next-page');
      
      if (prevButton) {
        prevButton.addEventListener('click', () => goToPage(currentPage - 1));
      }
      
      if (nextButton) {
        nextButton.addEventListener('click', () => goToPage(currentPage + 1));
      }
      
      performSearch();
    });
  </script>
</Layout>
