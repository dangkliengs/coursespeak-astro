---
import Layout from "../layouts/Layout.astro";
import { readDeals } from "../lib/store";

function normName(raw?: string | null) {
  if (!raw) return undefined;
  let v = String(raw).trim();
  v = v.replace(/&amp;/gi, "&");
  v = v.replace(/\s+/g, " ");
  return v || undefined;
}

function slugifyCategory(name: string) {
  if (name === "Uncategorized") return "uncategorized";
  let v = name.toLowerCase();
  v = v.replace(/&amp;/gi, "&");
  v = v.replace(/&/g, " and ");
  v = v.replace(/[^\w\s-]/g, "");
  v = v.trim();
  v = v.replace(/\s+/g, "-");
  v = v.replace(/-+/g, "-");
  return v;
}

// Get all deals and organize by categories
const deals = await readDeals();
const cats = new Map<string, { name: string; count: number; subs: Map<string, number> }>();

for (const d of deals) {
  const cName = normName(d.category) ?? "Uncategorized";
  const cKey = cName.toLowerCase();
  if (!cats.has(cKey)) cats.set(cKey, { name: cName, count: 0, subs: new Map() });
  const bucket = cats.get(cKey)!;
  bucket.count += 1;
  const sName = normName(d.subcategory);
  if (sName) {
    bucket.subs.set(sName, (bucket.subs.get(sName) || 0) + 1);
  }
}

const listRaw = Array.from(cats.values()).sort((a, b) => b.count - a.count);

// Add icon paths
const list = listRaw.map((c) => {
  const cSlug = slugifyCategory(c.name);
  let icon = "/categories/default.svg";
  // You can add specific icon logic here if needed
  return { ...c, icon, slug: cSlug };
});

const pageTitle = `All Categories & Subcategories | CourseSpeak`;
const pageDescription = "Browse all primary categories and subcategories of Udemy deals and free coupons on CourseSpeak.";
---

<Layout title={pageTitle} description={pageDescription}>
  <div style={{ maxWidth: "1400px", margin: "0 auto", padding: "2rem 1rem" }}>
    {/* Page Header - Same as deals page */}
    <div style={{ textAlign: "center", marginBottom: "3rem" }}>
      <h1 style={{ 
        fontSize: "2.5rem", 
        fontWeight: "800", 
        marginBottom: "1rem",
        background: "linear-gradient(135deg, #FFC107 0%, #FFD54F 100%)",
        WebkitBackgroundClip: "text",
        WebkitTextFillColor: "transparent",
        backgroundClip: "text"
      }}>
        All Categories & Subcategories
      </h1>
      <p style={{ 
        fontSize: "1.1rem", 
        color: "var(--muted)", 
        maxWidth: "600px", 
        margin: "0 auto",
        lineHeight: "1.6"
      }}>
        Explore every primary category and subcategory available on CourseSpeak. Select a topic to dive straight into updated Udemy coupons and 100% off courses curated for that niche.
      </p>
    </div>

    {list.length === 0 ? (
      <div style={{ 
        textAlign: "center", 
        padding: "3rem", 
        background: "var(--card)", 
        borderRadius: "20px",
        border: "1px solid var(--border)"
      }}>
        <h3 style={{ color: "var(--text)", marginBottom: "1rem", fontSize: "1.5rem" }}>
          No Categories Found
        </h3>
        <p style={{ color: "var(--muted)", marginBottom: "1.5rem", lineHeight: "1.6" }}>
          We loaded {deals.length} deals but couldn't resolve any categories. Try refreshing the deals source or verify each deal includes a category value.
        </p>
        <a href="/deals" style={{ 
          padding: "12px 24px",
          background: "linear-gradient(135deg, #FFC107 0%, #FFD54F 100%)",
          border: "2px solid #FFC107",
          borderRadius: "8px",
          color: "white",
          textDecoration: "none",
          fontWeight: "600",
          display: "inline-block"
        }}>
          Browse All Deals
        </a>
      </div>
    ) : (
      <div style={{ 
        display: "grid", 
        gridTemplateColumns: "repeat(auto-fill, minmax(280px, 1fr))", 
        gap: "1.5rem"
      }}>
        {list.map((c) => (
          <div style={{ 
            background: "var(--card)", 
            border: "1px solid var(--border)",
            borderRadius: "16px",
            padding: "1.5rem",
            transition: "all 0.3s ease",
            cursor: "pointer"
          }}>
            <a 
              href={`/categories/${c.slug}`} 
              style={{ textDecoration: "none", color: "inherit" }}
            >
              <div style={{ display: "flex", alignItems: "center", gap: "1rem", marginBottom: "1rem" }}>
                <div style={{
                  width: "40px",
                  height: "40px",
                  borderRadius: "10px",
                  background: "linear-gradient(135deg, #FFC107 0%, #FFD54F 100%)",
                  display: "flex",
                  alignItems: "center",
                  justifyContent: "center",
                  color: "white",
                  fontWeight: "bold",
                  fontSize: "1.2rem"
                }}>
                  {c.name.charAt(0)}
                </div>
                <div style={{ flex: 1 }}>
                  <h3 style={{ 
                    margin: 0, 
                    color: "var(--text)", 
                    fontSize: "1.1rem",
                    fontWeight: "700"
                  }}>
                    {c.name}
                  </h3>
                  <p style={{ 
                    margin: 0, 
                    color: "var(--muted)", 
                    fontSize: "0.9rem" 
                  }}>
                    {c.count} courses available
                  </p>
                </div>
              </div>
              
              {c.subs.size > 0 && (
                <div style={{ display: "flex", gap: "0.5rem", flexWrap: "wrap" }}>
                  {Array.from(c.subs.entries())
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3)
                    .map(([sub, n]) => (
                      <span
                        style={{
                          padding: "0.25rem 0.75rem",
                          borderRadius: "20px",
                          fontSize: "0.8rem",
                          backgroundColor: "rgba(255, 193, 7, 0.1)",
                          border: "1px solid rgba(255, 193, 7, 0.3)",
                          color: "#FFC107",
                          fontWeight: "500"
                        }}
                        title={`${sub} (${n})`}
                      >
                        {sub}
                      </span>
                    ))}
                  {c.subs.size > 3 && (
                    <span style={{ 
                      fontSize: "0.8rem", 
                      color: "var(--muted)",
                      padding: "0.25rem 0.75rem"
                    }}>
                      +{c.subs.size - 3} more
                    </span>
                  )}
                </div>
              )}
            </a>
          </div>
        ))}
      </div>
    )}
  </div>
</Layout>
