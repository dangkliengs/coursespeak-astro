---
import Layout from "../layouts/Layout.astro";
import DealsList from "../components/DealsList";
import HeaderSearch from "../components/HeaderSearch";
import { readDeals } from "../lib/store";
import { uniqueProviders } from "../lib/mockData";

// Get current month and year for dynamic title
const currentDate = new Date();
const monthNames = ["January", "February", "March", "April", "May", "June",
  "July", "August", "September", "October", "November", "December"];
const currentMonth = monthNames[currentDate.getMonth()];
const currentYear = currentDate.getFullYear();

// Dynamic title and description
const pageTitle = `100% Off and Free Udemy Coupons ${currentMonth} ${currentYear} | Coursespeak`;
const pageDescription = `Discover 100% off Udemy coupons and free courses updated daily. Find the best deals on programming, design, marketing, and more.`;

const allDeals = await readDeals();

// Initial pagination
const PAGE_SIZE = 12;
const initialItems = allDeals.slice(0, PAGE_SIZE);
const totalPages = Math.ceil(allDeals.length / PAGE_SIZE);

// Extract top categories for filter links
const categories = [
  ...new Set(allDeals.map((d) => d.category).filter(Boolean)),
].slice(0, 8);

// Slugify function for category URLs
function slugifyCategory(name: string) {
  if (name === "Uncategorized") return "uncategorized";
  let v = name.toLowerCase();
  v = v.replace(/&amp;/gi, "&");
  v = v.replace(/&/g, " and ");
  v = v.replace(/[^\w\s-]/g, "");
  v = v.trim();
  v = v.replace(/\s+/g, "-");
  v = v.replace(/-+/g, "-");
  return v;
}

// Featured Deals (e.g. top rated)
const featuredDeals = allDeals
  .filter((d) => d.rating && d.rating >= 4.5)
  .sort((a, b) => (b.rating || 0) - (a.rating || 0))
  .slice(0, 3);

import DealCard from "../components/DealCard";
---

<Layout 
    title={pageTitle}
    description={pageDescription}
>
  <div style={{ background: "#0b0d12", minHeight: "100vh", color: "#e2e8f0" }}>
    <main>
      {/* Hero Section */}
      <section
        style={{
          position: "relative",
          padding: "6rem 1rem",
          textAlign: "center",
          overflow: "hidden",
          background:
            "radial-gradient(circle at 50% 0%, #1f2330 0%, #0b0d12 100%)",
        }}
      >
        <div class="container" style={{ position: "relative", zIndex: 10 }}>
          <h1
            style={{
              fontSize: "3.5rem",
              fontWeight: 800,
              lineHeight: 1.1,
              marginBottom: "1.5rem",
              background: "linear-gradient(to right, #fff, #94a3b8)",
              WebkitBackgroundClip: "text",
              WebkitTextFillColor: "transparent",
            }}
          >
            Unlock Your Potential<br />with Premium Course Deals
          </h1>
          <p
            style={{
              fontSize: "1.25rem",
              color: "#94a3b8",
              maxWidth: "600px",
              margin: "0 auto 2.5rem",
            }}
          >
            Discover hand-picked coupons for Udemy, Coursera, and more. <br
            />Save up to 100% on top-rated courses today.
          </p>

          {/* Categories Pills */}
          <div
            style={{
              display: "flex",
              flexWrap: "wrap",
              justifyContent: "center",
              gap: "0.75rem",
            }}
          >
            <a href="/" class="pill active">All Deals</a>
            {
              categories.map((cat: any) => (
                <a href={`/category/${slugifyCategory(cat)}`} class="pill">
                  {cat.replace(/&amp;/g, '&')}
                </a>
              ))
            }
          </div>
        </div>

        {/* Decorative elements */}
        <div
          style={{
            position: "absolute",
            top: "20%",
            left: "10%",
            width: "300px",
            height: "300px",
            background: "#3b82f6",
            filter: "blur(120px)",
            opacity: 0.1,
            borderRadius: "50%",
          }}
        >
        </div>
        <div
          style={{
            position: "absolute",
            bottom: "10%",
            right: "10%",
            width: "250px",
            height: "250px",
            background: "#8b5cf6",
            filter: "blur(100px)",
            opacity: 0.1,
            borderRadius: "50%",
          }}
        >
        </div>
      </section>

      {/* Featured Section */}
      {
        featuredDeals.length > 0 && (
          <section
            class="container"
            style={{ padding: "2rem 1rem", marginBottom: "2rem" }}
          >
            <div
              style={{
                display: "flex",
                justifyContent: "space-between",
                alignItems: "end",
                marginBottom: "1.5rem",
              }}
            >
              <h2
                style={{ fontSize: "1.75rem", fontWeight: 700, color: "#fff" }}
              >
                Featured Courses
              </h2>
              <a
                href="/deals"
                style={{
                  color: "#3b82f6",
                  textDecoration: "none",
                  fontWeight: 600,
                }}
              >
                View all &rarr;
              </a>
            </div>
            <div
              style={{
                display: "grid",
                gridTemplateColumns: "repeat(auto-fill, minmax(280px, 1fr))",
                gap: "2rem",
              }}
            >
              {featuredDeals.map((deal) => (
                <DealCard client:visible deal={deal} />
              ))}
            </div>
          </section>
        )
      }

      {/* Main List Section */}
      <section class="container" style={{ padding: "0 1rem 4rem" }}>
        <h2
          style={{
            fontSize: "1.75rem",
            fontWeight: 700,
            color: "#fff",
            marginBottom: "1.5rem",
          }}
        >
          Latest Drops
        </h2>
        <DealsList
          client:load
          initialItems={initialItems}
          initialPage={1}
          totalPages={totalPages}
          baseParams={{}}
          allDeals={allDeals}
        />
      </section>
    </main>
  </div>
</Layout>

<style>
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }
  .pill {
    padding: 0.6rem 1.25rem;
    border-radius: 9999px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #cbd5e1;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  .pill:hover,
  .pill.active {
    background: #fff;
    color: #000;
    border-color: #fff;
    transform: translateY(-1px);
  }
  @media (max-width: 768px) {
    h1 {
      font-size: 2.5rem !important;
    }
  }
</style>
